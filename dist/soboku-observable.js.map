{"version":3,"file":"soboku-observable.js","sources":["../src/observable.ts","../src/sequenceEqual.ts","../src/timer.ts"],"sourcesContent":["import { listener, reporter, Reporter, ReporterClass } from \"soboku\";\r\nimport { ISObservable } from \"../index.d\";\r\n\r\n\r\nexport abstract class SObservable<I, O, T extends Reporter<I>> implements ISObservable<I, O, T> {\r\n    public readonly input: T;\r\n    public readonly output = reporter<O>();\r\n    public readonly error = new ObservableErrorClass();\r\n    public readonly reset = reporter<true>();\r\n\r\n    constructor(input: T) {\r\n        this.input = input;\r\n        input.report(listener(this.onInput, this));\r\n        this.reset.report(listener(this.onReset, this));\r\n    }\r\n    \r\n    protected abstract onInput(val: I): void;\r\n    protected abstract onReset(): void;\r\n\r\n}\r\n\r\nexport  class ObservableErrorClass extends ReporterClass<Error> {\r\n\r\n    public next(err: Error) {\r\n        if (this.listenerCount() === 0) {\r\n            const unhandledError = new Error(`Unhandled observable error: ${err.name}: ${err.message}`);\r\n            unhandledError.name = \"UnhandledObservableErrorWarning\";\r\n            throw unhandledError;\r\n        }\r\n        return super.next(err);\r\n    }\r\n    \r\n}","import { reporter, ReporterClass, toStateHolder, Reporter, ISArray, IStateHolder } from \"soboku\";\r\nimport { ISObservable } from \"../index.d\";\r\nimport { SObservable } from \"./observable\";\r\n\r\n\r\nfunction isEqual(x: any, y: any): boolean {\r\n    return x === y;\r\n}\r\n\r\nclass SequenceEqualClass<T> extends SObservable<T, true, Reporter<T>> {\r\n    private readonly compare: (x: any, y: any) => boolean;\r\n    private readonly sequence: IStateHolder<T[]>;\r\n    private i = 0;\r\n\r\n    constructor(sequence: T[] | ISArray<T>, compare = isEqual) {\r\n        super(reporter<T>());\r\n        this.compare = compare;\r\n        this.sequence =  toStateHolder(sequence);\r\n    }\r\n\r\n    protected onInput(val: T): void {\r\n        const sequence = this.sequence.s();\r\n        if (this.compare(sequence[this.i], val) === false) {\r\n            this.i = 0;\r\n            return;\r\n        }\r\n        if (++this.i === sequence.length) {\r\n            this.i = 0;\r\n            this.output.next(true);\r\n        }\r\n    }\r\n\r\n    protected onReset() {\r\n        this.i = 0;\r\n    }\r\n    \r\n}\r\n\r\nexport function sequenceEqual<T>(sequence: T[] | ISArray<T>, compareFunc?: (x: T, y: T) => boolean): ISObservable<T, true, Reporter<T>> {\r\n    return new SequenceEqualClass(sequence, compareFunc);\r\n}\r\n","import { listener, state, ReporterClass, toStateHolder, Atom, Reporter, State, IStateHolder } from \"soboku\";\r\nimport { ISObservable } from \"../index.d\";\r\nimport { SObservable } from \"./observable\";\r\n\r\n\r\nabstract class TimerObservable extends SObservable<boolean, number, State<boolean>> {\r\n    protected readonly cb = () => this.output.next(Date.now());\r\n    protected readonly ms: IStateHolder<number>;\r\n    protected timer: NodeJS.Timer;\r\n    protected isRunning = false;\r\n\r\n    constructor(ms: Atom<number>) {\r\n        super(state(false));\r\n        const _ms = this.ms = toStateHolder(ms);\r\n        if (_ms instanceof ReporterClass)\r\n            _ms.report(listener(this.msChanged, this));\r\n    }\r\n\r\n    private msChanged(ms: number) {\r\n        if (this.isRunning) {\r\n            this.onInput(false);\r\n            this.onInput(true, ms);\r\n        }\r\n    }\r\n\r\n    protected onInput(trigger: boolean, ms?: number): void {\r\n        this.fire(trigger, ms || this.ms.s());\r\n        this.isRunning = trigger;\r\n    }\r\n\r\n    protected onReset() {\r\n        this.input.next(false);\r\n    }\r\n\r\n    protected abstract fire(trigger: boolean, ms: number): void;\r\n\r\n}\r\n\r\nclass IntervalObservable extends TimerObservable {\r\n\r\n    protected fire(trigger: boolean, ms: number) {\r\n        if (trigger === false) {\r\n            clearInterval(this.timer);\r\n        } else if (this.isRunning === false) {\r\n            this.timer = setInterval(this.cb, ms);\r\n        }\r\n    }\r\n    \r\n}\r\n\r\nclass TimeoutObservable extends TimerObservable {\r\n\r\n    protected fire(trigger: boolean, ms: number) {\r\n        clearTimeout(this.timer);\r\n        if (trigger) {\r\n            this.timer = setTimeout(this.cb, ms);\r\n        }\r\n    }\r\n\r\n}\r\n\r\n\r\nexport function interval(ms: Atom<number>): ISObservable<boolean, number, State<boolean>> {\r\n    return new IntervalObservable(ms);\r\n}\r\n\r\nexport function timeout(ms: Atom<number>): ISObservable<boolean, number, State<boolean>> {\r\n    return new TimeoutObservable(ms);\r\n}\r\n"],"names":["reporter","listener","ReporterClass","toStateHolder","state"],"mappings":"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"}